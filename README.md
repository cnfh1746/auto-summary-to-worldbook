# 自动总结世界书 - SillyTavern扩展

一个功能强大的SillyTavern扩展，可以自动将聊天记录总结并写入世界书。支持小总结、大总结、标签提取、内容排除和向量化功能。

## ✨ 主要功能

### 📝 小总结（自动/手动）
- **后台自动总结**：当未总结的消息达到设定阈值时自动触发
- **增量总结**：只总结新增的对话，保留历史总结
- **交互模式**：可选择在保存前预览和编辑总结内容
- **进度追踪**：自动记录已总结到第几楼，避免重复总结

### 📚 大总结
- **智能精炼**：将多个小总结合并压缩成精简的章节历史
- **避免冗余**：防止世界书条目过长影响性能
- **保留关键信息**：在压缩的同时保持重要剧情点

### 🏷️ 标签提取
- **精准总结**：只提取特定XML标签内的内容进行总结
- **支持多标签**：可同时指定多个标签（如`<content>`, `<narration>`）
- **灵活配置**：根据你的提示词格式自定义

### 🚫 内容排除规则
- **智能过滤**：总结前自动移除不需要的内容
- **多规则支持**：可添加多条排除规则
- **常用场景**：排除HTML注释、OOC内容、系统指令等

### 🧠 向量化支持
- **自动归档**：将旧的总结内容送入RAG向量数据库
- **节省Token**：保持世界书条目精简的同时不丢失历史信息
- **语义检索**：通过向量搜索调用历史记忆

### 📋 灵活的世界书配置
- **多种激活模式**：常驻激活或关键词触发
- **自定义插入位置**：控制总结在上下文中的位置
- **关键词设置**：自定义触发总结的关键词

## 📦 安装方法

1. 下载本扩展的所有文件
2. 将整个文件夹放入SillyTavern的扩展目录：
   ```
   SillyTavern/public/scripts/extensions/third-party/auto-summary-to-worldbook/
   ```
3. 重启SillyTavern或刷新页面
4. 在"扩展"设置中找到"自动总结世界书"

## 🚀 快速开始

### 基础配置

1. **启用扩展**
   - 勾选"启用自动总结功能"

2. **选择世界书目标**
   - **角色主世界书**：将总结写入当前角色的主世界书（需要角色已绑定世界书）
   - **专用世界书**：为每个对话创建独立的世界书

3. **设置保留消息数**
   - 建议设置为5-10条，保持最近的对话不被总结

### 小总结配置

1. **启用自动小总结**
   - 勾选后，达到阈值会自动触发总结

2. **设置触发阈值**
   - 建议20-30条消息，根据对话密度调整

3. **选择交互模式**
   - 勾选：每次总结前需要确认（推荐初次使用）
   - 不勾选：完全自动，无需人工干预

4. **自定义提示词**
   - 根据你的需求修改总结风格和要求

### 手动执行

- **手动小总结**：点击"手动执行小总结"按钮
- **手动大总结**：当积累多个小总结后，点击"手动执行大总结"进行精炼

## 🔧 高级功能

### 标签提取

如果你的角色使用XML标签格式化输出，可以开启标签提取：

```
1. 勾选"启用标签提取"
2. 在"要提取的标签"中输入：content, narration
3. 只有这些标签内的内容会被总结
```

### 内容排除规则

排除不需要总结的内容：

**示例规则：**
- 排除HTML注释：起始 `<!--` 结束 `-->`
- 排除OOC内容：起始 `<ooc>` 结束 `</ooc>`
- 排除系统指令：起始 `<system>` 结束 `</system>`

### 向量化集成

如果你使用了RAG向量数据库插件：

1. 勾选"启用向量化功能"
2. 执行大总结时，旧的小总结会自动送入向量库
3. 世界书保持精简，历史通过向量检索

### 自定义API

如果不想使用ST的默认API：

1. 填写API地址（OpenAI兼容格式）
2. 填写API密钥
3. 指定模型名称（如：gpt-4, claude-3-sonnet等）

## 📖 使用场景

### 场景1：长篇RP对话

```
设置：
- 触发阈值：25条
- 保留消息：10条
- 交互模式：关闭（完全自动）
- 大总结：每50-100楼执行一次

效果：全程自动化，无需手动干预
```

### 场景2：多分支剧情

```
设置：
- 触发阈值：15条
- 交互模式：开启（确认总结内容）
- 标签提取：开启，提取 <plot> 标签
- 排除规则：排除 <ooc> 内容

效果：精确捕捉剧情发展，过滤无关内容
```

### 场景3：长期角色记忆

```
设置：
- 向量化：开启
- 大总结频率：高（经常精炼）
- 世界书：专用世界书

效果：世界书保持小巧，历史通过向量检索
```

## 🎯 最佳实践

1. **初次使用**
   - 先手动执行几次，观察总结效果
   - 根据效果调整提示词和阈值

2. **提示词优化**
   - 小总结：详细记录，保留细节
   - 大总结：精炼压缩，突出重点

3. **性能考虑**
   - Token有限时：降低阈值，频繁总结
   - Token充足时：提高阈值，减少总结次数

4. **世界书管理**
   - 定期执行大总结，避免条目过长
   - 配合向量化使用，获得最佳效果

## 🔍 状态信息

扩展会实时显示：
- 功能启用状态
- 当前对话长度
- 已总结进度
- 自动触发条件

## ⚠️ 注意事项

1. **角色主世界书模式**
   - 必须先为角色绑定一个主世界书
   - 否则会报错提示

2. **专用世界书模式**
   - 每个对话会创建独立的世界书
   - 文件名格式：`AutoSummary-{对话ID}`

3. **API调用**
   - 每次总结会调用一次AI API
   - 注意你的API配额和费用

4. **向量化功能**
   - 需要额外安装RAG/向量数据库插件
   - 未安装时该功能不生效

## 🐛 故障排除

**问题：扩展不显示**
- 检查文件夹名称是否为纯英文
- 确认文件都在正确的目录下
- 刷新页面或重启ST

**问题：自动总结不触发**
- 确认已启用功能和自动小总结
- 检查是否达到触发阈值
- 查看控制台是否有错误信息

**问题：写入世界书失败**
- 角色主世界书模式：确认角色已绑定世界书
- 检查世界书是否存在且可写入
- 查看错误提示信息

**问题：总结质量不佳**
- 调整提示词，给出更明确的指示
- 尝试不同的模型
- 检查标签提取和排除规则是否正确

## 📄 技术细节

### 世界书条目格式

```
以下是依照顺序已发生剧情

---

【1楼至20楼详细总结记录】
{总结内容}

---

【21楼至40楼详细总结记录】
{总结内容}

本条勿动【前40楼总结已完成】否则后续总结无法进行。
```

进度印记用于追踪已总结的位置，请勿手动修改。

### 大总结后的格式

```
以下内容是【1楼-100楼】已发生的剧情回顾。

---

{精炼后的章节历史}

【前100楼篇章编撰已完成】

本条勿动【前100楼总结已完成】否则后续总结无法进行。
```

## 🤝 致谢

本扩展基于 [ST-Amily2-Chat-Optimisation](https://github.com/Wx-2025/ST-Amily2-Chat-Optimisation) 项目的自动总结功能重构而成，感谢原作者的出色工作。

## 📝 许可证

本项目采用 MIT 许可证。

## 🔗 相关链接

- [SillyTavern](https://github.com/SillyTavern/SillyTavern)
- [参考项目：Amily2号聊天优化助手](https://github.com/Wx-2025/ST-Amily2-Chat-Optimisation)

---

**祝你使用愉快！如有问题或建议，欢迎反馈。** 📖✨
